# ELK解决方案

## 部署ELK的背景

- 微服务系统日志分布在多台机器上，整体定位问题、解决问题周期较长

- 缺少应用层面的告警，可视化调用量分析

- 管理人员有相应服务器的权限，命令使用不当有误删除等安全隐患

  ​         

## 目标

- 微服务应用接入分布式链路追踪，确保logback日志的规范性
- 开发人员不需要服务器权限也能快捷的查找问题
- 可以根据业务需要从各个维度分析日志并展现
- 日志集中实时收集，查询问题不影响服务器正常运行
- 应用异常触达阈值告警，提前解决问题，化被动为主动
- 解决日志的长期保存问题

## 具体实施

1.日志的采集   Filebeat、logback Append

2.日志的汇总与过滤 kafka 、logstash

3.日志的存储     elaticsearch

4.日志的分析与查询    kibana



ELK技术栈(即Logstash + ElasticSearch + Kibana)属于业界已经应用比较广泛且成熟的开源方案，这套一站式解决方案基本上可以满足大部分企业对日志管理体系的需求。我们即选择ELK作为日志收集方案，其架构如下：



![img](https://pic4.zhimg.com/80/v2-8453780905df64756155c50d06cac263_hd.jpg)        

这种架构有如下优点：

1、 使用filebeat收集日志，减少应用服务器的压力

2、中间层使用kafka做消息队列。防止数据丢失同时也能起到削峰填谷的作用

3、Logstash根据需求过滤处理数据

4、ES两个数据节点一个主节点缓解压力

5、ElastAlert插件定时去查询ES里面的数据，根据用户配置实时告警

6、有kafka在前端支撑，es方便扩容



## 遇到的问题及解决方案

Elaticsearch cluster :

- es数据分片偏移严重，重启集群解决偏移问题。或者开启分片自动平衡
- es的表无限增长，后期不好管理，所以每个系统的日志按应用名称、日期进行分表
- es集群自动部署、平滑扩容二进制包运维成本高，目前使用的是kubernetes


Logstash:

- 单Logstash负载过高

- Grokparsefailure失败。这是由于日志消息正则匹配失败可通过如下网站调试：[grokdebug.herokuapp.com/](http://link.zhihu.com/?target=https%3A//link.juejin.im/%3Ftarget%3Dhttps%253A%252F%252Fgrokdebug.herokuapp.com%252F)

- 日志中的时间为系统时间不为日志输出的时间。这是由于logstash在写入ES的时候默认会生成写入时间点的时间戳@timestamp，kibana默认以@timestamp为时间过滤字段导致的

- 由于时区导致日志8小时的时差。引起这个问题主要是由于ELK各组件对时间的处理是基于“数据的存储和显示相分离”的设计原则，只要把表示绝对时间的时间戳存储数据库，在显示的时候根据用户设置的时区格式化为正确的时间。所以在logstash写入ES时存储为UTC时间，由于中国是东八区，所以会比日志时间晚8个小时，而kibana是从ES读出UTC时间后，通过浏览器获取当时时区，在UTC时间的基础上加上浏览器时区偏移值，再展现出来。当logstash没有正确设置时区时即会导致这个问题

  如上两个问题以通过在logstash filter阶段使用date插件处理

```
date {

match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss"]

target => "@timestamp"

timezone => "+08:00"

}
```

kibana:

- 分片太多，index不好维护，查询效率越来越慢，目前采用按日期进行分表

   使用logstash-app*   即可选中app所有的日志

- kibana采取的是本地服务器的时间要和 web页面的时间一致，否则查询会有异常情况

kafka:

- kafka的高并发高可用集群搭建

   





## 部署之后成效

- 系统故障报警更及时，以前在系统出现故障时需要等到URL监控、或者数据库监控报警才能发现问题，这两个监控粒度较大，往往发现故障时已经很严重了。部署ElastAlert监控之后能实时监控nginx日志的状态码，当某个错误状态码在1分钟内达到500个就告警。及时有效的告警服务给故障排查留出了宝贵的时间，以便在最短的时间内解决问题，把影响降到最小。

- 可以实时快速的查询每个接口的响应时间。优化响应慢的接口，提高系统服务质量
- 故障排查更迅速，当碰到有异常流量时及时过滤出异常IP\UserAgent，添加防火墙，减少系统安全事故
- 回收开发人员服务器上的权限，减少误操作的可能
- 每周生成质量报表，统计每个项目每周的ERROR、WARN日志



## 总结

- 在部署过程中或多或少会碰到各种故障，排查故障时需仔细观察日志，找到引发故障的关键字，再根据关键字做有针对性的排查。其次要仔细观察配置文件了解各配置的原理，上下文关系。
- 实施项目前要充分调研项目的可行性 
- 在部署完毕之后可以根据实际情况进行调优，使系统处于最佳的运行状态